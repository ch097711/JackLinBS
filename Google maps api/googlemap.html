<!DOCTYPE html>
<html lang="en">

<head>
    <title>口罩地圖</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAlKWP4uWjQIR3WDAWLAu6rUhBfc3_ppag&callback=initMap&libraries=places&v=weekly"
        defer></script>

    <style>
        /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
        #map {
            height: 100%;
        }

        #pano {
            height: 40%;
        }

        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-size: 62.5%;
            font-family: arial, "Microsoft JhengHei", "微軟正黑體", sans-serif !important;
        }

        .content a {
            text-decoration: none;
        }

        .content h2 {
            font-size: 1rem;
            color: rgb(208, 208, 213);
        }

        .content span {
            font-size: 1.6rem;
        }

        .content .updatedTime {
            color: rgb(208, 208, 213);
            font-size: 1rem;
        }

        .content {
            box-sizing: border-box;
            top: 0;
            left: 0;
            position: absolute;
            background-color: white;
            height: 100%;
            width: 400px;
            border: 1px soild rgb(229, 229, 234);
            box-shadow: 1px 2px 30px rgba(28, 28, 30, .3);
            border-bottom-right-radius: 1.6rem;
            border-top-right-radius: 1.6rem;
            padding-left: 10px;
            padding-right: 10px;
            font-size: 2rem;
            display: none;
        }

        .button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            font-size: 15px;
            line-height: 20px;
            text-align: center;
            color: #fff;
            background-color: #acacac;
            border-radius: 50%;
            cursor: pointer;
        }

        /* @media (min-) */
    </style>
</head>

<body>
    <div id="map"></div>
    <div class="content">
        <div class="text">

        </div>
        <div id="pano"></div>
    </div>

    <script>
        // "use strict";
        let map;
        var myLatLng = { lat: 25.0415976, lng: 121.5354045 };
        let url = "https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json";
        var content = document.querySelector(".content")
        async function getMaskdata() {
            let res = await fetch(url);
            let json = await res.json();
            let data = await json.features;
            return data;
        };
        getMaskdata().then(data => { console.log(data[1].geometry.coordinates); })

        function initMap() {

            map = new google.maps.Map(document.getElementById("map"), {
                center: myLatLng,
                zoom: 15,
                disableDefaultUI: true,
                styles: [
                    {
                        "featureType": "all",
                        "elementType": "geometry.fill",
                        "stylers": [
                            {
                                "weight": "2.00"
                            }
                        ]
                    },
                    {
                        "featureType": "all",
                        "elementType": "geometry.stroke",
                        "stylers": [
                            {
                                "color": "#9c9c9c"
                            }
                        ]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "all",
                        "stylers": [
                            {
                                "color": "#f2f2f2"
                            }
                        ]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "geometry.fill",
                        "stylers": [
                            {
                                "color": "#ffffff"
                            }
                        ]
                    },
                    {
                        "featureType": "landscape.man_made",
                        "elementType": "geometry.fill",
                        "stylers": [
                            {
                                "color": "#ffffff"
                            }
                        ]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "all",
                        "stylers": [
                            {
                                "visibility": "off"
                            }
                        ]
                    },
                    {
                        "featureType": "road",
                        "elementType": "all",
                        "stylers": [
                            {
                                "saturation": -100
                            },
                            {
                                "lightness": 45
                            },
                            {
                                "visibility": "simplified"
                            }
                        ]
                    },
                    {
                        "featureType": "road",
                        "elementType": "geometry.fill",
                        "stylers": [
                            {
                                "color": "#eeeeee"
                            }
                        ]
                    },
                    {
                        "featureType": "road",
                        "elementType": "labels.text.fill",
                        "stylers": [
                            {
                                "color": "#7b7b7b"
                            }
                        ]
                    },
                    {
                        "featureType": "road",
                        "elementType": "labels.text.stroke",
                        "stylers": [
                            {
                                "color": "#ffffff"
                            }
                        ]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "all",
                        "stylers": [
                            {
                                "visibility": "simplified"
                            }
                        ]
                    },
                    {
                        "featureType": "road.arterial",
                        "elementType": "labels.icon",
                        "stylers": [
                            {
                                "visibility": "off"
                            }
                        ]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "all",
                        "stylers": [
                            {
                                "visibility": "off"
                            }
                        ]
                    },
                    {
                        "featureType": "water",
                        "elementType": "all",
                        "stylers": [
                            {
                                "color": "#46bcec"
                            },
                            {
                                "visibility": "on"
                            }
                        ]
                    },
                    {
                        "featureType": "water",
                        "elementType": "geometry.fill",
                        "stylers": [
                            {
                                "color": "#c8d7d4"
                            }
                        ]
                    },
                    {
                        "featureType": "water",
                        "elementType": "labels.text.fill",
                        "stylers": [
                            {
                                "color": "#070707"
                            }
                        ]
                    },
                    {
                        "featureType": "water",
                        "elementType": "labels.text.stroke",
                        "stylers": [
                            {
                                "color": "#ffffff"
                            }
                        ]
                    }
                ]
            });

            let infowindow = new google.maps.InfoWindow();
            var directionsService = new google.maps.DirectionsService();


            var address;
            var myLatLng;

            getMaskdata().then(data => {

                for (var i = 0; i < data.length; i++) {
                    var lat = data[i].geometry.coordinates[1];
                    var lng = data[i].geometry.coordinates[0];
                    var maskAdult = data[i].properties.mask_adult;
                    var maskChild = data[i].properties.mask_child;
                    var address = data[i].properties.address;
                    var phone = data[i].properties.phone;
                    var updated = data[i].properties.updated;
                    var icon = {
                        url: number(maskAdult), // url
                        scaledSize: new google.maps.Size(50, 50),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(0, 0)
                    };
                    function number(x) { //判斷數量
                        if (x > 100) {
                            return "locationlot.png"
                        }
                        else if (x < 100 && x > 0) {
                            return "locationlittle.png"
                        }
                        else {
                            return "locationnone.png"
                        }
                    }
                    var marker = new google.maps.Marker({ //放置圖標
                        position: { lat: lat, lng: lng },
                        map: map,
                        icon: icon,
                        // label: "abc",
                        // title: 'Hello World!'
                    });
                    var content = `<h1>${data[i].properties.name}</h1><br>成人口罩 : ${maskAdult}<br>小孩口罩 : ${maskChild}<a href="https://www.google.com/maps/dir/current+location/${address}"><h2>地址</h2><span>${address}</span></a><a href="tel:${phone}"><h2>電話</h2><span>${phone}</span></a><div class="updatedTime">更新時間 : ${updated.slice(-8)}</div><div class="button">x</div>`
                    contentSet(marker, content, { lat: lat, lng: lng });
                }




                function contentSet(marker, content, pos) { //設定content 調整街景預設視角角度
                    marker.addListener('click', () => {
                        map.setZoom(18);//放大到選中藥局
                        map.setCenter(pos);
                        document.querySelector(".content").style.display = "block"
                        document.querySelector(".text").innerHTML = content;
                        document.querySelector(".button").addEventListener("click", function () {
                            document.querySelector(".content").style.display = "none"
                            map.setZoom(17);
                        })
                        myLatLng = new google.maps.LatLng(pos);
                        var request = {
                            origin: pos,
                            destination: pos,
                            travelMode: google.maps.DirectionsTravelMode.DRIVING
                        };
                        directionsService.route(request, directionsCallback);

                        function directionsCallback(response, status) {
                            if (status == google.maps.DirectionsStatus.OK) {
                                var latlng = response.routes[0].legs[0].start_location;
                                var panorama = new google.maps.StreetViewPanorama(document.getElementById("pano"));
                                panorama.setPosition(latlng);

                                var heading = google.maps.geometry.spherical.computeHeading(latlng, myLatLng);
                                panorama.setPov({
                                    heading: heading,
                                    pitch: 0,
                                    zoom: 1
                                });
                                panorama.setVisible(true);
                            }
                        }
                    })
                }
            })

            if (navigator.geolocation) { //定位
                navigator.geolocation.getCurrentPosition(function (position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    var marker = new google.maps.Marker({
                        position: pos,
                        icon: {
                            url: "oie_frame000.gif",
                            scaledSize: new google.maps.Size(50, 50),
                        },
                        map: map
                    });
                    map.setZoom(17);
                    map.setCenter(pos);
                    // function clickButton() {
                    //     map.setCenter(pos);
                    // }
                });
            } else {
                // Browser doesn't support Geolocation
                // alert("未允許或遭遇錯誤！");
            }

        }


    </script>
</body>

</html>